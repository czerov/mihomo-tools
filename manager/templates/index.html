<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mihomo Web</title>
    
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="apple-touch-icon" href="/static/logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --bg-body: #f4f6f9;
            --bg-sidebar: #fff;
            --bg-card: #fff;
            --bg-header: #fff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #e1e4e8;
            --input-bg: #fff;
            --log-bg: #1e1e1e;
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-card: #252525;
            --bg-header: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #333;
            --input-bg: #2b2b2b;
            --log-bg: #000;
        }
        
        /* === æ ¸å¿ƒä¿®å¤ï¼šæ·±è‰²æ¨¡å¼å¯è§æ€§ä¼˜åŒ– === */
        [data-theme="dark"] .form-control::placeholder {
            color: #adb5bd !important;
            opacity: 1;
        }
        [data-theme="dark"] .text-muted {
            color: #adb5bd !important;
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; transition: background-color 0.3s; }
        
        .sidebar { 
            background: var(--bg-sidebar); 
            min-height: 100vh; 
            padding: 20px; 
            border-right: 1px solid var(--border-color); 
            width: 260px; 
            position: fixed; 
            top: 0; left: 0;
            z-index: 1040; 
            transition: transform 0.3s ease-in-out, background-color 0.3s; 
            display: flex;
            flex-direction: column;
        }
        
        .content-area { margin-left: 260px; padding: 30px; transition: margin-left 0.3s; }
        .mobile-header { display: none !important; }
        .overlay { display: none !important; }

        @media (max-width: 768px) {
            .sidebar { 
                position: fixed !important;
                top: 0 !important; left: 0 !important;
                width: 280px !important; 
                height: 100vh !important;
                transform: translateX(-100%);
                box-shadow: 4px 0 12px rgba(0,0,0,0.1);
                border-right: none !important;
                z-index: 9999 !important;
                overflow-y: auto !important; 
            }
            .sidebar.show { transform: translateX(0); }
            
            .content-area { 
                margin-left: 0 !important; 
                padding: 15px !important; 
                padding-top: 80px !important; 
            }
            
            .mobile-header {
                display: flex !important;
                align-items: center;
                justify-content: space-between;
                height: 60px;
                padding: 0 20px;
                background: var(--bg-header);
                border-bottom: 1px solid var(--border-color);
                position: fixed;
                top: 0; left: 0; right: 0;
                z-index: 1030;
            }
            
            .overlay {
                display: block !important;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 9000 !important;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s;
                backdrop-filter: blur(2px);
            }
            .overlay.show { opacity: 1; visibility: visible; }
            .sidebar-logo-area { display: none !important; }
        }

        .nav-link { color: var(--text-muted); margin-bottom: 8px; border-radius: 8px; font-weight: 500; padding: 12px; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; }
        .nav-link.active { background-color: #0d6efd !important; color: #fff !important; box-shadow: 0 4px 6px rgba(13, 110, 253, 0.3); }
        .nav-link i { margin-right: 12px; font-size: 1.1em; }

        .card { border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 24px; border-radius: 12px; background: var(--bg-card); color: var(--text-main); transition: background-color 0.3s; }
        .card-header { background: transparent; border-bottom: 1px solid var(--border-color); font-weight: 700; padding: 18px 20px; }
        
        .form-control { background-color: var(--input-bg); border-color: var(--border-color); color: var(--text-main); }
        .form-control:focus { background-color: var(--input-bg); color: var(--text-main); border-color: #0d6efd; }
        .form-label { color: var(--text-muted); font-size: 0.9em; margin-bottom: 0.3rem; }
        
        .log-box { 
            background: var(--log-bg); 
            font-family: 'JetBrains Mono', 'Consolas', monospace; 
            height: 650px; 
            overflow-y: auto; 
            padding: 15px; 
            border-radius: 8px; 
            font-size: 12px; 
            line-height: 1.6; 
            border: 1px solid var(--border-color);
            scroll-behavior: smooth;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; display: flex; align-items: flex-start; }
        .log-time { color: #888; margin-right: 10px; min-width: 130px; }
        .log-tag { padding: 1px 6px; border-radius: 4px; font-weight: bold; margin-right: 10px; font-size: 11px; display: inline-block; min-width: 50px; text-align: center; }
        .tag-info { background: #198754; color: #fff; }
        .tag-warn { background: #ffc107; color: #000; }
        .tag-error { background: #dc3545; color: #fff; }
        .tag-debug { background: #6c757d; color: #fff; }
        .log-msg { color: #dcdcdc; word-break: break-all; }

        .logo-img { width: 32px; height: 32px; border-radius: 8px; margin-right: 10px; vertical-align: middle; }
        textarea#config-editor { font-family: 'Consolas', monospace; font-size: 13px; background-color: var(--input-bg); color: var(--text-main); border: none; }
    </style>
</head>
<body>

<div class="mobile-header">
    <div class="d-flex align-items-center">
        <button class="btn btn-link text-reset p-0 me-3" onclick="toggleSidebar()">
            <i class="bi bi-list fs-1"></i>
        </button>
        <div class="d-flex align-items-center">
            <img src="/static/logo.png" alt="Logo" class="logo-img" style="width: 28px; height: 28px;">
            <h5 class="fw-bold m-0">Mihomo</h5>
        </div>
    </div>
    <div class="d-flex align-items-center">
        <button class="btn btn-sm btn-outline-secondary border-0 me-2" onclick="window.location.reload()" title="åˆ·æ–°é¡µé¢">
            <i class="bi bi-arrow-clockwise" style="font-size: 1.2rem;"></i>
        </button>
        <button class="btn btn-sm btn-outline-secondary border-0" onclick="toggleTheme()">
            <i class="bi bi-moon-stars-fill" id="theme-icon-mobile"></i>
        </button>
    </div>
</div>

<div class="overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-logo-area d-flex justify-content-between align-items-center mb-5 px-2">
        <div class="d-flex align-items-center">
            <img src="/static/logo.png" alt="Logo" class="logo-img">
            <h3 class="fw-bold text-primary m-0" style="font-size: 1.5rem;">Mihomo</h3>
        </div>
        <button class="btn btn-sm btn-outline-secondary border-0" onclick="toggleTheme()" title="åˆ‡æ¢æ·±è‰²æ¨¡å¼">
            <i class="bi bi-moon-stars-fill" id="theme-icon-pc"></i>
        </button>
    </div>
    
    <div class="nav flex-column nav-pills me-3" id="mainTab" role="tablist">
        <button class="nav-link active" id="tab-dash-btn" data-bs-toggle="pill" data-bs-target="#tab-dash" onclick="closeSidebar()"><i class="bi bi-grid-1x2"></i> æ¦‚è§ˆä¸æ§åˆ¶</button>
        <button class="nav-link" id="tab-tasks-btn" data-bs-toggle="pill" data-bs-target="#tab-tasks" onclick="loadConfig(); closeSidebar()"><i class="bi bi-sliders"></i> è®¢é˜…ä¸ä»»åŠ¡</button>
        <button class="nav-link" id="tab-notify-btn" data-bs-toggle="pill" data-bs-target="#tab-notify" onclick="loadSettings(); closeSidebar()"><i class="bi bi-bell"></i> é€šçŸ¥ä¸­å¿ƒ</button>
        <button class="nav-link" id="tab-logs-btn" data-bs-toggle="pill" data-bs-target="#tab-logs" onclick="closeSidebar()"><i class="bi bi-terminal"></i> è¿è¡Œæ—¥å¿—</button>
        
        <a href="/logout" class="nav-link text-danger mt-3 border border-danger">
            <i class="bi bi-box-arrow-left me-2"></i> é€€å‡ºç™»å½•
        </a>
    </div>
</div>

<div class="content-area">
    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-dash">
            <div class="row g-4 mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">ç³»ç»ŸæœåŠ¡çŠ¶æ€</h5>
                                <span id="status-text" class="text-muted">æ£€æµ‹ä¸­...</span>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="control('start')"><i class="bi bi-play-fill"></i></button>
                                <button class="btn btn-warning" onclick="control('restart')"><i class="bi bi-arrow-clockwise"></i></button>
                                <button class="btn btn-danger" onclick="control('stop')"><i class="bi bi-stop-fill"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header"><i class="bi bi-lightning-charge"></i> å¿«æ·å…¥å£</div>
                        <div class="card-body d-grid gap-3">
                            <button class="btn btn-outline-primary text-start p-3" onclick="window.open('http://'+location.hostname+':9090/ui')">
                                <div class="fw-bold"><i class="bi bi-window"></i> æ‰“å¼€ Dashboard</div>
                                <div class="small opacity-75">Zashboard é¢æ¿</div>
                            </button>
                            <button class="btn btn-outline-success text-start p-3" onclick="control('update_geo')">
                                <div class="fw-bold"><i class="bi bi-geo-alt"></i> æ›´æ–° Geo æ•°æ®åº“</div>
                                <div class="small opacity-75">ç«‹å³æ›´æ–° IP åº“</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-tasks">
            <div class="card border-primary border-1" style="border-left-width: 4px;">
                <div class="card-header text-primary">
                    <i class="bi bi-link-45deg"></i> è®¢é˜…ç®¡ç†
                </div>
                <div class="card-body">
                    <label class="form-label fw-bold">å®Œæ•´é…ç½®æ–‡ä»¶è®¢é˜…é“¾æ¥</label>
                    <div class="input-group mb-2">
                        <span class="input-group-text"><i class="bi bi-globe"></i></span>
                        <input type="text" class="form-control" id="sub_url" placeholder="http://...">
                    </div>
                    
                    <label class="form-label fw-bold text-success mt-2">æœ¬åœ°ç›´è¿ç½‘æ®µ (é˜²å›å®¶è§„åˆ™å¯¼è‡´å›ç¯)</label>
                    <div class="input-group mb-2">
                        <span class="input-group-text"><i class="bi bi-diagram-2"></i></span>
                        <input type="text" class="form-control" id="local_cidr" placeholder="ä¾‹å¦‚: 192.168.1.0/24 (ç•™ç©ºåˆ™ä¸å¯ç”¨)">
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">è‡ªåŠ¨ä¿ç•™é¢æ¿é…ç½®</small>
                        <button class="btn btn-primary" onclick="saveAndUpdateSub()">
                            <i class="bi bi-cloud-download"></i> ä¿å­˜å¹¶æ›´æ–°
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-clock-history"></i> è‡ªåŠ¨åŒ–ä»»åŠ¡
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6 border-end border-secondary">
                            <h6 class="fw-bold text-success">è‡ªåŠ¨æ›´æ–°è®¢é˜…</h6>
                            <div class="form-check form-switch my-2">
                                <input class="form-check-input" type="checkbox" id="cron_sub_enabled">
                                <label class="form-check-label">å¼€å¯</label>
                            </div>
                            <input type="text" class="form-control font-monospace mt-1" id="cron_sub_sched" value="0 5 * * *">
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold text-info">è‡ªåŠ¨æ›´æ–° Geo</h6>
                            <div class="form-check form-switch my-2">
                                <input class="form-check-input" type="checkbox" id="cron_geo_enabled">
                                <label class="form-check-label">å¼€å¯</label>
                            </div>
                            <input type="text" class="form-control font-monospace mt-1" id="cron_geo_sched" value="0 4 * * *">
                        </div>
                    </div>
                    <hr class="border-secondary">
                    <div class="text-end">
                        <button class="btn btn-primary" onclick="saveSettings(false)">
                            <i class="bi bi-save"></i> ä»…ä¿å­˜è®¾ç½®
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-file-earmark-code"></i> é…ç½®æ–‡ä»¶ (config.yaml)</span>
                    <button class="btn btn-outline-primary btn-sm" onclick="saveConfig()">ä¿å­˜é‡å¯</button>
                </div>
                <div class="card-body p-0">
                    <textarea id="config-editor" class="form-control" style="height: 500px; padding: 15px;"></textarea>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-notify">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center py-3">
                    <span class="fs-5 fw-bold text-primary">
                        <i class="bi bi-megaphone-fill me-2"></i>é€šçŸ¥é…ç½®
                    </span>
                    <button class="btn btn-primary btn-sm fw-bold px-3" onclick="control('test_notify')">
                        <i class="bi bi-send-fill me-1"></i> å‘é€æµ‹è¯•
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="notify_tg">
                            <label class="form-check-label fw-bold">Telegram Bot</label>
                        </div>
                        <div class="row g-3 ps-2">
                            <div class="col-md-6">
                                <label class="form-label">Bot Token</label>
                                <input type="text" class="form-control" id="tg_token" placeholder="Bot Token">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Chat ID</label>
                                <input type="text" class="form-control" id="tg_id" placeholder="Chat ID">
                            </div>
                        </div>
                    </div>
                    <hr class="border-secondary">
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="notify_api">
                            <label class="form-check-label fw-bold">Webhook API</label>
                        </div>
                        <div class="ps-2">
                            <input type="text" class="form-control" id="api_url" placeholder="http://...">
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3" onclick="saveSettings(false)">ğŸ’¾ ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-logs">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">ç³»ç»Ÿæ—¥å¿—</h5>
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="auto-scroll-switch" checked>
                        <label class="form-check-label small text-muted">è‡ªåŠ¨åˆ·æ–°</label>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" onclick="control('fix_logs')">ä¿®å¤æ—¥å¿—</button>
                </div>
            </div>
            <div id="log-display" class="log-box">
                <div class="text-muted text-center mt-5">ç­‰å¾…åŠ è½½...</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
        document.getElementById('sidebar-overlay').classList.toggle('show');
    }
    
    function closeSidebar() {
        if(window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('show');
            document.getElementById('sidebar-overlay').classList.remove('show');
        }
    }

    let logInterval = null;
    function startLogPolling() {
        if(logInterval) clearInterval(logInterval);
        loadLogs(); 
        logInterval = setInterval(() => {
            if (document.getElementById('auto-scroll-switch').checked) loadLogs();
        }, 3000); 
    }
    function stopLogPolling() {
        if(logInterval) { clearInterval(logInterval); logInterval = null; }
    }
    document.getElementById('tab-logs-btn').addEventListener('shown.bs.tab', startLogPolling);
    document.getElementById('tab-logs-btn').addEventListener('hidden.bs.tab', stopLogPolling);
    
    function loadLogs() {
        api('/logs').then(res => {
            const rawLogs = res.logs || "";
            const logContainer = document.getElementById('log-display');
            const isAtBottom = (logContainer.scrollHeight - logContainer.scrollTop - logContainer.clientHeight) < 50;

            const lines = rawLogs.split('\n').filter(line => line.trim() !== '').reverse();
            let html = '';
            lines.forEach(line => {
                const match = line.match(/time="([^"]+)" level=([^ ]+) msg="([^"]+)"/);
                if (match) {
                    let time = match[1].replace('T', ' ').split('.')[0];
                    let level = match[2].toUpperCase();
                    let msg = match[3];
                    let badgeClass = 'tag-info';
                    if(level === 'WARNING' || level === 'WARN') badgeClass = 'tag-warn';
                    if(level === 'ERROR' || level === 'FATAL') badgeClass = 'tag-error';
                    if(level === 'DEBUG') badgeClass = 'tag-debug';
                    html += `<div class="log-entry"><span class="log-tag ${badgeClass}">${level}</span><span class="log-time">${time}</span><span class="log-msg">${msg}</span></div>`;
                } else {
                    html += `<div class="log-entry"><span class="log-msg text-muted">${line}</span></div>`;
                }
            });
            if (logContainer.innerHTML !== html) {
                logContainer.innerHTML = html;
                if (isAtBottom) logContainer.scrollTop = logContainer.scrollHeight;
            }
        });
    }

    function toggleTheme() {
        const body = document.body;
        const iconMobile = document.getElementById('theme-icon-mobile');
        const iconPC = document.getElementById('theme-icon-pc');
        const isDark = body.getAttribute('data-theme') === 'dark';
        if (isDark) {
            body.removeAttribute('data-theme');
            if(iconMobile) iconMobile.classList.replace('bi-sun-fill', 'bi-moon-stars-fill');
            if(iconPC) iconPC.classList.replace('bi-sun-fill', 'bi-moon-stars-fill');
            localStorage.setItem('theme', 'light');
            document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff');
        } else {
            body.setAttribute('data-theme', 'dark');
            if(iconMobile) iconMobile.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
            if(iconPC) iconPC.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
            localStorage.setItem('theme', 'dark');
            document.querySelector('meta[name="theme-color"]').setAttribute('content', '#121212');
        }
    }
    if (localStorage.getItem('theme') === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        setTimeout(() => {
           const iconMobile = document.getElementById('theme-icon-mobile');
           const iconPC = document.getElementById('theme-icon-pc');
           if(iconMobile) iconMobile.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
           if(iconPC) iconPC.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
        }, 100);
        document.querySelector('meta[name="theme-color"]').setAttribute('content', '#121212');
    }

    const tabButtons = document.querySelectorAll('button[data-bs-toggle="pill"]');
    tabButtons.forEach(btn => {
        btn.addEventListener('shown.bs.tab', event => localStorage.setItem('activeTab', event.target.id));
    });
    
    const activeTabId = localStorage.getItem('activeTab');
    if (activeTabId) {
        const tabTrigger = document.getElementById(activeTabId);
        if(tabTrigger) {
            new bootstrap.Tab(tabTrigger).show();
            if(activeTabId === 'tab-tasks-btn') loadConfig();
            if(activeTabId === 'tab-notify-btn') loadSettings(); 
            if(activeTabId === 'tab-logs-btn') startLogPolling();
        }
    }

    async function api(path, data) {
        const opts = data ? { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) } : {};
        const resp = await fetch('/api'+path, opts);
        
        if (resp.status === 401) {
            window.location.href = '/login';
            return;
        }
        
        return resp.json();
    }

    function control(act) {
        if(act === 'test_notify' && !confirm("ç¡®å®šå‘é€æµ‹è¯•æ¶ˆæ¯å—ï¼Ÿå»ºè®®å…ˆä¿å­˜é…ç½®ã€‚")) return;
        api('/control', {action: act}).then(res => {
            alert(res.message || (res.success ? 'æ“ä½œæˆåŠŸ' : 'æ“ä½œå¤±è´¥'));
            if(act === 'fix_logs') loadLogs();
        });
    }

    function loadConfig() {
        api('/config').then(res => document.getElementById('config-editor').value = res.content || '');
        loadSettings(); 
    }

    function saveConfig() {
        if(!confirm('ç¡®å®šä¿å­˜å¹¶é‡å¯æœåŠ¡ï¼Ÿ')) return;
        const content = document.getElementById('config-editor').value;
        api('/config', {content: content}).then(res => {
            alert(res.message);
            if(res.success) control('restart');
        });
    }

    function saveAndUpdateSub() {
        const url = document.getElementById('sub_url').value;
        if(!url) return alert("è¯·å…ˆå¡«å†™è®¢é˜…é“¾æ¥ï¼");
        if(!confirm("ç¡®å®šè¦ä¿å­˜é“¾æ¥å¹¶è¦†ç›–å½“å‰é…ç½®æ–‡ä»¶å—ï¼Ÿ")) return;
        saveSettings(true).then(() => {
            alert("æ­£åœ¨ä¸‹è½½è®¢é˜…...å®Œæˆåç¼–è¾‘å™¨ä¼šè‡ªåŠ¨åˆ·æ–°ã€‚");
            api('/control', {action: 'update_sub'}).then(res => {
                alert(res.message);
                if(res.success) loadConfig();
            });
        });
    }

    function loadSettings() {
        api('/settings').then(res => {
            const isTrue = (val) => val === true || val === 'true';
            document.getElementById('notify_tg').checked = isTrue(res.notify_tg);
            document.getElementById('tg_token').value = res.tg_token;
            document.getElementById('tg_id').value = res.tg_id;
            document.getElementById('notify_api').checked = isTrue(res.notify_api);
            document.getElementById('api_url').value = res.api_url;
            if(document.getElementById('sub_url')) document.getElementById('sub_url').value = res.sub_url; 
            
            // ã€ä¿®æ”¹ç‚¹ã€‘åŠ è½½æœ¬åœ°ç½‘æ®µé…ç½®
            if(document.getElementById('local_cidr')) document.getElementById('local_cidr').value = res.local_cidr || '';
            
            if(document.getElementById('cron_sub_enabled')) document.getElementById('cron_sub_enabled').checked = isTrue(res.cron_sub_enabled);
            if(document.getElementById('cron_sub_sched')) document.getElementById('cron_sub_sched').value = res.cron_sub_sched;
            if(document.getElementById('cron_geo_enabled')) document.getElementById('cron_geo_enabled').checked = isTrue(res.cron_geo_enabled);
            if(document.getElementById('cron_geo_sched')) document.getElementById('cron_geo_sched').value = res.cron_geo_sched;
        });
    }

    async function saveSettings(silent = false) {
        const res = await api('/settings', {
            notify_tg: String(document.getElementById('notify_tg').checked),
            tg_token: document.getElementById('tg_token').value,
            tg_id: document.getElementById('tg_id').value,
            notify_api: String(document.getElementById('notify_api').checked),
            api_url: document.getElementById('api_url').value,
            sub_url: document.getElementById('sub_url') ? document.getElementById('sub_url').value : '',
            
            // ã€ä¿®æ”¹ç‚¹ã€‘ä¿å­˜æœ¬åœ°ç½‘æ®µé…ç½®
            local_cidr: document.getElementById('local_cidr') ? document.getElementById('local_cidr').value : '',

            cron_sub_enabled: document.getElementById('cron_sub_enabled') ? String(document.getElementById('cron_sub_enabled').checked) : 'false',
            cron_sub_sched: document.getElementById('cron_sub_sched') ? document.getElementById('cron_sub_sched').value : '',
            cron_geo_enabled: document.getElementById('cron_geo_enabled') ? String(document.getElementById('cron_geo_enabled').checked) : 'false',
            cron_geo_sched: document.getElementById('cron_geo_sched') ? document.getElementById('cron_geo_sched').value : ''
        });
        if(!silent) alert(res.message);
        return res;
    }

    setInterval(() => {
        api('/status').then(res => {
            const el = document.getElementById('status-text');
            el.innerHTML = res.running ? '<span class="text-success fw-bold">â— è¿è¡Œä¸­</span>' : '<span class="text-danger fw-bold">â— å·²åœæ­¢</span>';
        });
    }, 5000);
</script>
</body>
</html>
