<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mihomo ç®¡ç†é¢æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; }
        .main-container { max-width: 1000px; margin: 30px auto; background: #fff; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.05); overflow: hidden; }
        .sidebar { background: #2c3e50; color: #fff; min-height: 100vh; padding: 20px; }
        .nav-pills .nav-link { color: #b0c4de; margin-bottom: 10px; border-radius: 8px; }
        .nav-pills .nav-link.active { background-color: #3498db; color: #fff; }
        .nav-pills .nav-link:hover { background-color: #34495e; color: #fff; }
        .content-area { padding: 30px; }
        .status-badge { font-size: 0.9em; padding: 5px 10px; border-radius: 20px; }
        .log-box { background: #1e1e1e; color: #00ff00; font-family: monospace; height: 500px; overflow-y: scroll; padding: 15px; border-radius: 5px; font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="d-flex">
    <div class="sidebar d-flex flex-column flex-shrink-0" style="width: 240px;">
        <h4 class="mb-4 text-center"><i class="bi bi-box-seam"></i> Mihomo Tool</h4>
        <hr>
        <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-dashboard"><i class="bi bi-speedometer2"></i> ä»ªè¡¨ç›˜</button>
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-config" onclick="loadConfig()"><i class="bi bi-pencil-square"></i> è®¢é˜…ä¸é…ç½®</button>
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-settings" onclick="loadSettings()"><i class="bi bi-gear-fill"></i> è‡ªåŠ¨åŒ–ä¸é€šçŸ¥</button>
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-logs" onclick="loadLogs()"><i class="bi bi-terminal"></i> å®æ—¶æ—¥å¿—</button>
        </div>
        <div class="mt-auto text-center text-muted small">
            v2.0 Web Manager
        </div>
    </div>

    <div class="flex-grow-1 content-area">
        
        <div class="tab-content" id="v-pills-tabContent">
            <div class="tab-pane fade show active" id="tab-dashboard">
                <h3 class="mb-4">ç³»ç»ŸçŠ¶æ€</h3>
                
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">Mihomo æœåŠ¡</h5>
                                <p class="text-muted mb-0" id="uptime-text">æ£€æµ‹ä¸­...</p>
                            </div>
                            <span id="status-badge" class="badge bg-secondary status-badge">æœªçŸ¥</span>
                        </div>
                        <hr>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="control('start')"><i class="bi bi-play-fill"></i> å¯åŠ¨</button>
                            <button class="btn btn-danger" onclick="control('stop')"><i class="bi bi-stop-fill"></i> åœæ­¢</button>
                            <button class="btn btn-warning text-white" onclick="control('restart')"><i class="bi bi-arrow-clockwise"></i> é‡å¯</button>
                            <a href="http://'+window.location.hostname+':9090/ui" target="_blank" class="btn btn-outline-primary ms-auto" onclick="this.href='http://'+window.location.hostname+':9090/ui'"><i class="bi bi-window"></i> æ‰“å¼€é¢æ¿ (Zashboard)</a>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6><i class="bi bi-globe"></i> èµ„æºæ›´æ–°</h6>
                                <p class="text-muted small">æ›´æ–° GeoIP/GeoSite æ•°æ®åº“æ–‡ä»¶ã€‚</p>
                                <button class="btn btn-outline-dark btn-sm" onclick="control('update_geo')">ç«‹å³æ›´æ–° Geo</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6><i class="bi bi-cpu"></i> æ ¸å¿ƒç®¡ç†</h6>
                                <p class="text-muted small">æ›´æ–° Mihomo å†…æ ¸åˆ°æœ€æ–°ç‰ˆã€‚</p>
                                <button class="btn btn-outline-dark btn-sm" onclick="control('update_kernel')">æ›´æ–°å†…æ ¸ (Auto)</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="card border-0 shadow-sm border-start border-4 border-info">
                            <div class="card-body">
                                <h6><i class="bi bi-router"></i> ç½‘ç»œä¿®å¤</h6>
                                <p class="text-muted small mb-2">å¦‚æœé‡åˆ° Docker å®¹å™¨æ— æ³•ä¸Šç½‘æˆ–ç½‘å…³å¤±æ•ˆï¼Œè¯·ç‚¹å‡»æ­¤æŒ‰é’®é‡ç½®é˜²ç«å¢™è§„åˆ™ã€‚</p>
                                <button class="btn btn-info text-white btn-sm" onclick="control('net_init')">é‡ç½®ç½‘å…³ç½‘ç»œ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-config">
                <h3 class="mb-4">é…ç½®ç®¡ç†</h3>
                
                <div class="card mb-4">
                    <div class="card-header bg-white">ğŸ“¡ è®¢é˜…è®¾ç½®</div>
                    <div class="card-body">
                        <label class="form-label">æœºåœºè®¢é˜…é“¾æ¥ (Subscription URL)</label>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="sub-url" placeholder="http://example.com/subscribe?token=...">
                            <button class="btn btn-primary" type="button" onclick="updateSub()">ä¸‹è½½å¹¶è¦†ç›–é…ç½®</button>
                        </div>
                        <div class="form-text text-danger"><i class="bi bi-exclamation-circle"></i> æ³¨æ„ï¼šç‚¹å‡»ä¸‹è½½ä¼šè¦†ç›–å½“å‰çš„ config.yaml æ–‡ä»¶ï¼</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <span>ğŸ“ ç¼–è¾‘ config.yaml</span>
                        <button class="btn btn-success btn-sm" onclick="saveConfig()">ğŸ’¾ ä¿å­˜å¹¶é‡å¯æœåŠ¡</button>
                    </div>
                    <div class="card-body p-0">
                        <textarea id="config-editor" class="form-control border-0" style="height: 500px; font-family: monospace; background: #fafafa;"></textarea>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-settings">
                <h3 class="mb-4">è‡ªåŠ¨åŒ–è®¾ç½®</h3>
                
                <div class="card mb-4">
                    <div class="card-header bg-white">â° å®šæ—¶ä»»åŠ¡</div>
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="cron-enabled">
                            <label class="form-check-label" for="cron-enabled">å¼€å¯è‡ªåŠ¨æ›´æ–° (æ¯å¤©å‡Œæ™¨ 04:00 æ›´æ–° Geo å’Œ è®¢é˜…)</label>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-white">ğŸ”” é€šçŸ¥è®¾ç½® (Telegram)</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">é€šçŸ¥ç±»å‹</label>
                            <select class="form-select" id="notify-type">
                                <option value="none">å…³é—­é€šçŸ¥</option>
                                <option value="telegram">Telegram Bot</option>
                            </select>
                        </div>
                        <div id="tg-settings">
                            <div class="mb-3">
                                <label class="form-label">Bot Token</label>
                                <input type="text" class="form-control" id="tg-token" placeholder="123456:ABC-DEF...">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Chat ID</label>
                                <input type="text" class="form-control" id="tg-id" placeholder="123456789">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-logs">
                <h3 class="mb-4">ç³»ç»Ÿæ—¥å¿—</h3>
                <div id="log-display" class="log-box">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>
                <div class="mt-2 text-end">
                    <button class="btn btn-sm btn-secondary" onclick="loadLogs()">åˆ·æ–°æ—¥å¿—</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- API è°ƒç”¨å°è£… ---
    async function apiCall(endpoint, method='GET', data=null) {
        const opts = { method, headers: { 'Content-Type': 'application/json' } };
        if (data) opts.body = JSON.stringify(data);
        const res = await fetch(endpoint, opts);
        return await res.json();
    }

    // --- ä»ªè¡¨ç›˜ ---
    function loadStatus() {
        apiCall('/api/status').then(res => {
            const badge = document.getElementById('status-badge');
            const uptime = document.getElementById('uptime-text');
            if (res.running) {
                badge.className = 'badge bg-success status-badge';
                badge.textContent = 'è¿è¡Œä¸­';
                uptime.textContent = res.uptime;
            } else {
                badge.className = 'badge bg-danger status-badge';
                badge.textContent = 'å·²åœæ­¢';
                uptime.textContent = 'æœåŠ¡æœªè¿è¡Œ';
            }
        });
    }

    function control(action) {
        if (confirm('ç¡®è®¤æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ')) {
            apiCall('/api/control', 'POST', {action}).then(res => {
                alert(res.message);
                loadStatus();
            });
        }
    }

    // --- é…ç½® ---
    function loadConfig() {
        apiCall('/api/config').then(res => {
            document.getElementById('config-editor').value = res.content;
            document.getElementById('sub-url').value = res.sub_url;
        });
    }

    function saveConfig() {
        const content = document.getElementById('config-editor').value;
        if(confirm('ä¿å­˜å¹¶é‡å¯æœåŠ¡ï¼Ÿ')) {
            apiCall('/api/config', 'POST', {content}).then(res => {
                if(res.success) control('restart');
                else alert('ä¿å­˜å¤±è´¥: ' + res.message);
            });
        }
    }

    function updateSub() {
        const url = document.getElementById('sub-url').value;
        if(!url) return alert('è¯·è¾“å…¥é“¾æ¥');
        if(confirm('è­¦å‘Šï¼šè¿™å°†ä¼šè¦†ç›–å½“å‰çš„é…ç½®æ–‡ä»¶ï¼ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
            apiCall('/api/update_sub', 'POST', {url}).then(res => {
                alert(res.message);
                if(res.success) loadConfig();
            });
        }
    }

    // --- è®¾ç½® ---
    function loadSettings() {
        apiCall('/api/settings').then(res => {
            document.getElementById('cron-enabled').checked = res.cron_enabled;
            document.getElementById('notify-type').value = res.notify_type;
            document.getElementById('tg-token').value = res.tg_token;
            document.getElementById('tg-id').value = res.tg_id;
        });
    }

    function saveSettings() {
        const data = {
            cron_enabled: document.getElementById('cron-enabled').checked,
            notify_type: document.getElementById('notify-type').value,
            tg_token: document.getElementById('tg-token').value,
            tg_id: document.getElementById('tg-id').value
        };
        apiCall('/api/settings', 'POST', data).then(res => {
            alert(res.message);
        });
    }

    // --- æ—¥å¿— ---
    let logInterval = null;
    function loadLogs() {
        const fetchLog = () => {
            apiCall('/api/logs').then(res => {
                const box = document.getElementById('log-display');
                box.innerText = res.logs;
                box.scrollTop = box.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            });
        };
        fetchLog();
        // ç®€å•çš„è½®è¯¢ï¼Œç¦»å¼€æ ‡ç­¾é¡µæ—¶åº”è¯¥æ¸…é™¤ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
        if(logInterval) clearInterval(logInterval);
        logInterval = setInterval(fetchLog, 3000);
    }

    // åˆå§‹åŒ–
    loadStatus();
    setInterval(loadStatus, 5000);
</script>
</body>
</html>
