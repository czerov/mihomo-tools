<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mihomo WEB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --bg-body: #f4f6f9;
            --bg-sidebar: #fff;
            --bg-card: #fff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #e1e4e8;
            --input-bg: #fff;
            --log-bg: #1e1e1e;
        }

        /* é»‘æš—æ¨¡å¼å˜é‡ */
        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-card: #252525;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #333;
            --input-bg: #2b2b2b;
            --log-bg: #000;
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; transition: background-color 0.3s; }
        .sidebar { background: var(--bg-sidebar); min-height: 100vh; padding: 20px; border-right: 1px solid var(--border-color); width: 260px; position: fixed; z-index: 1000; transition: background-color 0.3s; }
        .content-area { margin-left: 260px; padding: 30px; }
        
        /* å¯¼èˆª */
        .nav-link { color: var(--text-muted); margin-bottom: 8px; border-radius: 8px; font-weight: 500; padding: 12px; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; }
        .nav-link.active { background-color: #0d6efd !important; color: #fff !important; box-shadow: 0 4px 6px rgba(13, 110, 253, 0.3); }
        .nav-link i { margin-right: 12px; font-size: 1.1em; }

        /* å¡ç‰‡ */
        .card { border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 24px; border-radius: 12px; background: var(--bg-card); color: var(--text-main); transition: background-color 0.3s; }
        .card-header { background: transparent; border-bottom: 1px solid var(--border-color); font-weight: 700; padding: 18px 20px; }
        
        /* è¾“å…¥æ¡† & æŒ‰é’® */
        .form-control { background-color: var(--input-bg); border-color: var(--border-color); color: var(--text-main); }
        .form-control:focus { background-color: var(--input-bg); color: var(--text-main); border-color: #0d6efd; }
        .form-label { color: var(--text-muted); font-size: 0.9em; margin-bottom: 0.3rem; }
        
        /* æ—¥å¿—æ ·å¼ä¼˜åŒ– (ä»¿ Infuse/Emby) */
        .log-box { 
            background: var(--log-bg); 
            font-family: 'JetBrains Mono', 'Consolas', monospace; 
            height: 650px; 
            overflow-y: auto; 
            padding: 15px; 
            border-radius: 8px; 
            font-size: 12px; 
            line-height: 1.6; 
            border: 1px solid var(--border-color);
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; display: flex; align-items: flex-start; }
        .log-time { color: #888; margin-right: 10px; min-width: 130px; }
        .log-tag { padding: 1px 6px; border-radius: 4px; font-weight: bold; margin-right: 10px; font-size: 11px; display: inline-block; min-width: 50px; text-align: center; }
        .tag-info { background: #198754; color: #fff; } /* Green */
        .tag-warn { background: #ffc107; color: #000; } /* Yellow */
        .tag-error { background: #dc3545; color: #fff; } /* Red */
        .tag-debug { background: #6c757d; color: #fff; } /* Grey */
        .log-msg { color: #dcdcdc; word-break: break-all; }

        /* ç¼–è¾‘å™¨ */
        textarea#config-editor { font-family: 'Consolas', monospace; font-size: 13px; background-color: var(--input-bg); color: var(--text-main); border: none; }
    </style>
</head>
<body>

<div class="sidebar d-flex flex-column">
    <div class="d-flex justify-content-between align-items-center mb-5 px-2">
        <h3 class="fw-bold text-primary m-0"><i class="bi bi-hdd-network"></i> Mihomo</h3>
        <button class="btn btn-sm btn-outline-secondary border-0" onclick="toggleTheme()" title="åˆ‡æ¢æ·±è‰²æ¨¡å¼">
            <i class="bi bi-moon-stars-fill" id="theme-icon"></i>
        </button>
    </div>
    
    <div class="nav flex-column nav-pills me-3" id="mainTab" role="tablist">
        <button class="nav-link active" id="tab-dash-btn" data-bs-toggle="pill" data-bs-target="#tab-dash"><i class="bi bi-grid-1x2"></i> æ¦‚è§ˆä¸æ§åˆ¶</button>
        <button class="nav-link" id="tab-tasks-btn" data-bs-toggle="pill" data-bs-target="#tab-tasks" onclick="loadSettings()"><i class="bi bi-sliders"></i> è®¢é˜…ä¸ä»»åŠ¡</button>
        <button class="nav-link" id="tab-notify-btn" data-bs-toggle="pill" data-bs-target="#tab-notify" onclick="loadSettings()"><i class="bi bi-bell"></i> é€šçŸ¥ä¸­å¿ƒ</button>
        <button class="nav-link" id="tab-logs-btn" data-bs-toggle="pill" data-bs-target="#tab-logs" onclick="loadLogs()"><i class="bi bi-terminal"></i> è¿è¡Œæ—¥å¿—</button>
    </div>
    <div class="mt-auto text-muted small ps-2">v2.4 Pro | <span id="ver-info">LXC</span></div>
</div>

<div class="content-area">
    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-dash">
            <div class="row g-4 mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">ç³»ç»ŸæœåŠ¡çŠ¶æ€</h5>
                                <span id="status-text" class="text-muted">æ£€æµ‹ä¸­...</span>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="control('start')"><i class="bi bi-play-fill"></i> å¯åŠ¨</button>
                                <button class="btn btn-warning" onclick="control('restart')"><i class="bi bi-arrow-clockwise"></i> é‡å¯</button>
                                <button class="btn btn-danger" onclick="control('stop')"><i class="bi bi-stop-fill"></i> åœæ­¢</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header"><i class="bi bi-lightning-charge"></i> å¿«æ·å…¥å£</div>
                        <div class="card-body d-grid gap-3">
                            <button class="btn btn-outline-primary text-start p-3" onclick="window.open('http://'+location.hostname+':9090/ui')">
                                <div class="fw-bold"><i class="bi bi-window"></i> æ‰“å¼€ Dashboard (Zashboard)</div>
                                <div class="small opacity-75">æŸ¥çœ‹æµé‡ã€åˆ‡æ¢èŠ‚ç‚¹ã€ç®¡ç†è§„åˆ™</div>
                            </button>
                            <button class="btn btn-outline-success text-start p-3" onclick="control('update_geo')">
                                <div class="fw-bold"><i class="bi bi-geo-alt"></i> æ›´æ–° Geo æ•°æ®åº“</div>
                                <div class="small opacity-75">ç«‹å³æ›´æ–° IP åº“å’ŒåŸŸåæ•°æ®åº“</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-tasks">
            
            <div class="card border-primary border-1" style="border-left-width: 4px;">
                <div class="card-header text-primary">
                    <i class="bi bi-link-45deg"></i> è®¢é˜…ç®¡ç†
                </div>
                <div class="card-body">
                    <label class="form-label fw-bold">æœºåœºè®¢é˜…é“¾æ¥</label>
                    <div class="input-group mb-2">
                        <span class="input-group-text"><i class="bi bi-globe"></i></span>
                        <input type="text" class="form-control" id="sub_url" placeholder="ç²˜è´´ä½ çš„è®¢é˜…é“¾æ¥ (http/https)...">
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">æç¤ºï¼šæ›´æ–°è®¢é˜…ä¼šè‡ªåŠ¨ä¸‹è½½é…ç½®ï¼Œå¹¶æ™ºèƒ½ä¿ç•™é¢æ¿ç«¯å£è®¾ç½®ã€‚</small>
                        <button class="btn btn-primary px-4" onclick="saveAndUpdateSub()">
                            <i class="bi bi-cloud-download"></i> ä¿å­˜å¹¶ç«‹å³æ›´æ–°
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-clock-history"></i> è‡ªåŠ¨åŒ–ä»»åŠ¡ (Crontab)
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6 border-end border-secondary">
                            <h6 class="fw-bold text-success"><i class="bi bi-arrow-repeat"></i> è‡ªåŠ¨æ›´æ–°è®¢é˜…</h6>
                            <div class="form-check form-switch my-3">
                                <input class="form-check-input" type="checkbox" id="cron_sub_enabled">
                                <label class="form-check-label">å¯ç”¨å®šæ—¶ä»»åŠ¡</label>
                            </div>
                            <label class="small text-muted">Cron è¡¨è¾¾å¼ (é»˜è®¤: æ¯å¤©å‡Œæ™¨5ç‚¹)</label>
                            <input type="text" class="form-control font-monospace mt-1" id="cron_sub_sched" value="0 5 * * *">
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold text-info"><i class="bi bi-globe2"></i> è‡ªåŠ¨æ›´æ–° Geo åº“</h6>
                            <div class="form-check form-switch my-3">
                                <input class="form-check-input" type="checkbox" id="cron_geo_enabled">
                                <label class="form-check-label">å¯ç”¨å®šæ—¶ä»»åŠ¡</label>
                            </div>
                            <label class="small text-muted">Cron è¡¨è¾¾å¼ (é»˜è®¤: æ¯å¤©å‡Œæ™¨4ç‚¹)</label>
                            <input type="text" class="form-control font-monospace mt-1" id="cron_geo_sched" value="0 4 * * *">
                        </div>
                    </div>
                    <hr class="border-secondary">
                    <div class="text-end">
                        <button class="btn btn-secondary" onclick="saveSettings(false)">
                            <i class="bi bi-save"></i> ä»…ä¿å­˜å®šæ—¶ä»»åŠ¡è®¾ç½®
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-file-earmark-code"></i> é…ç½®æ–‡ä»¶ç¼–è¾‘å™¨ (config.yaml)</span>
                    <button class="btn btn-outline-primary btn-sm" onclick="saveConfig()">ä¿å­˜å¹¶é‡å¯æœåŠ¡</button>
                </div>
                <div class="card-body p-0">
                    <textarea id="config-editor" class="form-control" style="height: 500px; padding: 15px;"></textarea>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-notify">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-megaphone"></i> é€šçŸ¥é…ç½®</span>
                    <button class="btn btn-secondary btn-sm" onclick="control('test_notify')"><i class="bi bi-send"></i> å‘é€æµ‹è¯•æ¶ˆæ¯</button>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="notify_tg">
                            <label class="form-check-label fw-bold">å¯ç”¨ Telegram Bot</label>
                        </div>
                        <div class="row g-3 ps-4 border-start border-3 border-primary">
                            <div class="col-md-6"><input type="text" class="form-control" id="tg_token" placeholder="Bot Token"></div>
                            <div class="col-md-6"><input type="text" class="form-control" id="tg_id" placeholder="Chat ID"></div>
                        </div>
                    </div>
                    <hr class="border-secondary">
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="notify_api">
                            <label class="form-check-label fw-bold">å¯ç”¨ Webhook API</label>
                        </div>
                        <div class="ps-4 border-start border-3 border-info">
                            <input type="text" class="form-control" id="api_url" placeholder="http://10.10.2.11:8088/api/v1/notify...">
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3" onclick="saveSettings(false)">ğŸ’¾ ä¿å­˜é€šçŸ¥é…ç½®</button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-logs">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">ç³»ç»Ÿæ—¥å¿—</h5>
                <div>
                    <button class="btn btn-outline-danger btn-sm me-2" onclick="control('fix_logs')">ä¿®å¤æ—¥å¿—æœåŠ¡</button>
                    <button class="btn btn-secondary btn-sm" onclick="loadLogs()">åˆ·æ–°æ—¥å¿—</button>
                </div>
            </div>
            <div id="log-display" class="log-box">
                <div class="text-muted text-center mt-5">ç‚¹å‡»åˆ·æ–°åŠ è½½æ—¥å¿—...</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- 1. é»‘æš—æ¨¡å¼é€»è¾‘ ---
    function toggleTheme() {
        const body = document.body;
        const icon = document.getElementById('theme-icon');
        if (body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme');
            icon.classList.replace('bi-sun-fill', 'bi-moon-stars-fill');
            localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            icon.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
            localStorage.setItem('theme', 'dark');
        }
    }
    // åˆå§‹åŒ–ä¸»é¢˜
    if (localStorage.getItem('theme') === 'dark') {
        toggleTheme(); // Apply dark
    }

    // --- 2. æ ‡ç­¾é¡µè®°å¿†é€»è¾‘ ---
    // ç›‘å¬ç‚¹å‡»ï¼Œä¿å­˜çŠ¶æ€
    const tabButtons = document.querySelectorAll('button[data-bs-toggle="pill"]');
    tabButtons.forEach(btn => {
        btn.addEventListener('shown.bs.tab', event => {
            localStorage.setItem('activeTab', event.target.id);
        });
    });
    // åŠ è½½æ—¶æ¢å¤
    const activeTabId = localStorage.getItem('activeTab');
    if (activeTabId) {
        const tabTrigger = document.getElementById(activeTabId);
        if(tabTrigger) {
            const tabInstance = new bootstrap.Tab(tabTrigger);
            tabInstance.show();
            // å¦‚æœæ˜¯é…ç½®æˆ–æ—¥å¿—é¡µï¼Œé¡ºä¾¿è§¦å‘åŠ è½½
            if(activeTabId === 'tab-tasks-btn') loadConfig();
            if(activeTabId === 'tab-logs-btn') loadLogs();
        }
    }

    // --- 3. åŸºç¡€ API å°è£… ---
    async function api(path, data) {
        const opts = data ? { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) } : {};
        return (await fetch('/api'+path, opts)).json();
    }

    function control(act) {
        if(act === 'test_notify') {
            if(!confirm("ç¡®å®šå‘é€æµ‹è¯•æ¶ˆæ¯å—ï¼Ÿå»ºè®®å…ˆä¿å­˜é…ç½®ã€‚")) return;
        }
        api('/control', {action: act}).then(res => {
            alert(res.message || (res.success ? 'æ“ä½œæˆåŠŸ' : 'æ“ä½œå¤±è´¥'));
            if(act === 'fix_logs') loadLogs();
        });
    }

    // --- 4. é…ç½®ä¸è®¢é˜…é€»è¾‘ ---
    function loadConfig() {
        api('/config').then(res => {
            document.getElementById('config-editor').value = res.content || '';
        });
        loadSettings(); 
    }

    function saveConfig() {
        if(!confirm('ç¡®å®šä¿å­˜å¹¶é‡å¯æœåŠ¡ï¼Ÿ')) return;
        const content = document.getElementById('config-editor').value;
        api('/config', {content: content}).then(res => {
            alert(res.message);
            if(res.success) control('restart');
        });
    }

    // å…³é”®ä¿®å¤ï¼šæ›´æ–°æˆåŠŸåè‡ªåŠ¨åˆ·æ–°ç¼–è¾‘å™¨
    function saveAndUpdateSub() {
        const url = document.getElementById('sub_url').value;
        if(!url) return alert("è¯·å…ˆå¡«å†™è®¢é˜…é“¾æ¥ï¼");
        if(!confirm("ç¡®å®šè¦ä¿å­˜é“¾æ¥å¹¶è¦†ç›–å½“å‰é…ç½®æ–‡ä»¶å—ï¼Ÿ")) return;

        // ä¿å­˜è®¾ç½®
        saveSettings(true).then(() => {
            // è§¦å‘æ›´æ–°
            alert("æ­£åœ¨ä¸‹è½½è®¢é˜…ï¼Œè¯·ç¨å€™...ä¸‹è½½å®Œæˆåç¼–è¾‘å™¨ä¼šè‡ªåŠ¨åˆ·æ–°ã€‚");
            api('/control', {action: 'update_sub'}).then(res => {
                alert(res.message);
                if(res.success) {
                    // æ›´æ–°æˆåŠŸï¼Œå¼ºåˆ¶åˆ·æ–°ç¼–è¾‘å™¨å†…å®¹ï¼
                    loadConfig();
                }
            });
        });
    }

    // --- 5. è®¾ç½®åŠ è½½ä¸ä¿å­˜ ---
    function loadSettings() {
        api('/settings').then(res => {
            document.getElementById('notify_tg').checked = res.notify_tg;
            document.getElementById('tg_token').value = res.tg_token;
            document.getElementById('tg_id').value = res.tg_id;
            document.getElementById('notify_api').checked = res.notify_api;
            document.getElementById('api_url').value = res.api_url;
            
            if(document.getElementById('sub_url')) document.getElementById('sub_url').value = res.sub_url; 
            if(document.getElementById('cron_sub_enabled')) document.getElementById('cron_sub_enabled').checked = res.cron_sub_enabled;
            if(document.getElementById('cron_sub_sched')) document.getElementById('cron_sub_sched').value = res.cron_sub_sched;
            if(document.getElementById('cron_geo_enabled')) document.getElementById('cron_geo_enabled').checked = res.cron_geo_enabled;
            if(document.getElementById('cron_geo_sched')) document.getElementById('cron_geo_sched').value = res.cron_geo_sched;
        });
    }

    async function saveSettings(silent = false) {
        const res = await api('/settings', {
            notify_tg: document.getElementById('notify_tg').checked,
            tg_token: document.getElementById('tg_token').value,
            tg_id: document.getElementById('tg_id').value,
            notify_api: document.getElementById('notify_api').checked,
            api_url: document.getElementById('api_url').value,
            sub_url: document.getElementById('sub_url') ? document.getElementById('sub_url').value : '',
            cron_sub_enabled: document.getElementById('cron_sub_enabled') ? document.getElementById('cron_sub_enabled').checked : false,
            cron_sub_sched: document.getElementById('cron_sub_sched') ? document.getElementById('cron_sub_sched').value : '',
            cron_geo_enabled: document.getElementById('cron_geo_enabled') ? document.getElementById('cron_geo_enabled').checked : false,
            cron_geo_sched: document.getElementById('cron_geo_sched') ? document.getElementById('cron_geo_sched').value : ''
        });
        if(!silent) alert(res.message);
        return res;
    }

    // --- 6. æ—¥å¿—è§£æä¸ç¾åŒ– (æ ¸å¿ƒæ”¹è¿›) ---
    function loadLogs() {
        api('/logs').then(res => {
            const rawLogs = res.logs || "";
            const logContainer = document.getElementById('log-display');
            
            // 1. åˆ†å‰²è¡Œ -> 2. è¿‡æ»¤ç©ºè¡Œ -> 3. å€’åºæ’åˆ—
            const lines = rawLogs.split('\n').filter(line => line.trim() !== '').reverse();
            
            let html = '';
            lines.forEach(line => {
                // æ­£åˆ™åŒ¹é… Mihomo/Logrus æ ¼å¼: time="xxx" level=xxx msg="xxx"
                // ç¤ºä¾‹: time="2026-01-27T11:06:30Z" level=info msg="Configuration complete"
                const match = line.match(/time="([^"]+)" level=([^ ]+) msg="([^"]+)"/);
                
                if (match) {
                    let time = match[1].replace('T', ' ').split('.')[0]; // ç®€å•å¤„ç†æ—¶é—´
                    let level = match[2].toUpperCase();
                    let msg = match[3];
                    
                    let badgeClass = 'tag-info';
                    if(level === 'WARNING' || level === 'WARN') badgeClass = 'tag-warn';
                    if(level === 'ERROR' || level === 'FATAL') badgeClass = 'tag-error';
                    if(level === 'DEBUG') badgeClass = 'tag-debug';
                    
                    html += `
                        <div class="log-entry">
                            <span class="log-tag ${badgeClass}">${level}</span>
                            <span class="log-time">${time}</span>
                            <span class="log-msg">${msg}</span>
                        </div>
                    `;
                } else {
                    // åŒ¹é…ä¸åˆ°æ ¼å¼çš„æ™®é€šæ—¥å¿—
                    html += `<div class="log-entry"><span class="log-msg text-muted">${line}</span></div>`;
                }
            });
            
            logContainer.innerHTML = html;
        });
    }

    // è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
    setInterval(() => {
        api('/status').then(res => {
            const el = document.getElementById('status-text');
            el.innerHTML = res.running ? '<span class="text-success fw-bold">â— è¿è¡Œä¸­</span>' : '<span class="text-danger fw-bold">â— å·²åœæ­¢</span>';
        });
    }, 5000);
</script>
</body>
</html>
